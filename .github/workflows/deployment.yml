# This workflow runs when a release is published, or the workflow is manually dispatched
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy (git tag)"
        required: true
        type: string

name: Deploy to Pterodactyl

jobs:
  call-build-workflow:
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ github.event.release.tag_name || inputs.version }}

  deploy:
    runs-on: ubuntu-latest
    needs: call-build-workflow
    environment: production

    env:
      PANEL_URL: ${{ secrets.PANEL_URL }}
      PANEL_SERVER_ID: ${{ secrets.PANEL_SERVER_ID }}
      PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      CLOUDLARED_VERSION: 2026.2.0
      CLOUDLARED_SHA256: e90aa057bfe72c15071eb2706f739097550623b55c4e3ab98286f45e9bf145f4

    steps:
      - name: Verify secrets & normalize panel URL
        id: normalize-panel
        run: |
          if [ -z "$PANEL_URL" ] || [ -z "$PANEL_SERVER_ID" ] || [ -z "$PANEL_API_KEY" ] || [ -z "$CF_ACCESS_CLIENT_ID" ] || [ -z "$CF_ACCESS_CLIENT_SECRET" ]; then
            echo "Error: Required environment variables are not set"
            exit 1
          fi
          # Remove trailing slashes from URL if present
          PANEL_URL="${PANEL_URL%/}"
          PANEL_SCHEME="https"
          if [[ "$PANEL_URL" == http://* ]]; then
            PANEL_SCHEME="http"
          fi
          PANEL_HOST_WITH_PORT="${PANEL_URL#http://}"
          PANEL_HOST_WITH_PORT="${PANEL_HOST_WITH_PORT#https://}"
          PANEL_HOST_WITH_PORT="${PANEL_HOST_WITH_PORT%%/*}"
          PANEL_HOST="${PANEL_HOST_WITH_PORT%%:*}"
          PANEL_PORT="${PANEL_HOST_WITH_PORT##*:}"
          if [ "$PANEL_PORT" = "$PANEL_HOST_WITH_PORT" ]; then
            if [ "$PANEL_SCHEME" = "http" ]; then
              PANEL_PORT="80"
            else
              PANEL_PORT="443"
            fi
          fi
          PANEL_REMOTE_ORIGIN="${PANEL_SCHEME}://${PANEL_HOST_WITH_PORT}"
          echo "panel_url=$PANEL_URL" >> $GITHUB_OUTPUT
          echo "panel_remote_origin=$PANEL_REMOTE_ORIGIN" >> $GITHUB_OUTPUT
          echo "panel_host=$PANEL_HOST" >> $GITHUB_OUTPUT
          echo "panel_host_with_port=$PANEL_HOST_WITH_PORT" >> $GITHUB_OUTPUT
          echo "panel_port=$PANEL_PORT" >> $GITHUB_OUTPUT

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb "https://github.com/cloudflare/cloudflared/releases/download/${CLOUDLARED_VERSION}/cloudflared-linux-amd64.deb"
          ACTUAL_SHA256="$(shasum -a 256 cloudflared.deb | awk '{print $1}')"
          if [ "$ACTUAL_SHA256" != "$CLOUDLARED_SHA256" ]; then
            echo "Error: cloudflared.deb SHA256 mismatch"
            echo "Expected: $CLOUDLARED_SHA256"
            echo "Actual:   $ACTUAL_SHA256"
            exit 1
          fi
          sudo dpkg -i cloudflared.deb

      - name: Start Cloudflare Access proxy
        env:
          CF_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          PANEL_HOST: ${{ steps.normalize-panel.outputs.panel_host }}
        run: |
          LOCAL_PORT="8080"
          echo "Starting cloudflared tunnel on 127.0.0.1:${LOCAL_PORT}..."
          nohup cloudflared access proxy --hostname "$PANEL_HOST" --url "http://127.0.0.1:${LOCAL_PORT}" \
            --service-token-id "$CF_ID" \
            --service-token-secret "$CF_SECRET" > cloudflared.log 2>&1 &
          sleep 5
          echo "Testing panel connectivity via local tunnel..."
          if ! curl -f -I --max-time 5 --retry 5 --retry-delay 2 --retry-all-errors "http://127.0.0.1:${LOCAL_PORT}"; then
            echo "Cloudflared failed to start. Recent logs:"
            cat cloudflared.log
            exit 1
          fi

      - name: Generate safe artifact name
        id: artifact-name
        run: |
          NAME="${{ inputs.version || github.event.release.tag_name }}"
          echo "safe_name=${NAME//\//-}" >> $GITHUB_OUTPUT

      - name: Download Build Artifact
        uses: actions/download-artifact@v6
        with:
          name: build-artifact-${{ steps.artifact-name.outputs.safe_name }}
          path: build-artifact

      - name: Create Backup
        id: create-backup
        uses: maxouxax/pterodactyl-create-backup-action@v1
        with:
          panel-url: http://127.0.0.1:8080
          api-key: ${{ secrets.PANEL_API_KEY }}
          server-id: ${{ secrets.PANEL_SERVER_ID }}

      - name: Create Archive for Upload
        run: |
          tar -czf app.tgz -C build-artifact .

      - name: Upload Artifact to Pterodactyl Panel
        id: upload
        uses: rexlManu/pterodactyl-upload-action@v2.5
        with:
          panel-host: http://127.0.0.1:8080
          api-key: ${{ secrets.PANEL_API_KEY }}
          restart: true
          server-id: ${{ secrets.PANEL_SERVER_ID }}
          source: app.tgz
          decompress-target: true
          target: app.tgz

      - name: Waiting for previous step to finish
        run: sleep 10

      - name: Cleanup
        run: |
          rm app.tgz
          rm -rf build-artifact
