# This workflow runs when a release is published, or the workflow is manually dispatched
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (git tag)'
        required: true
        type: string

name: Deploy to Pterodactyl

jobs:
  call-build-workflow:
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ github.event.release.tag_name || inputs.version }}

  deploy:
    runs-on: ubuntu-latest
    needs: call-build-workflow
    environment: production

    env:
      PANEL_URL: ${{ secrets.PANEL_URL }}
      PANEL_SERVER_ID: ${{ secrets.PANEL_SERVER_ID }}
      PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}

    steps:
      - name: Verify secrets & normalize panel URL
        id: normalize-panel
        run: |
          if [ -z "$PANEL_URL" ] || [ -z "$PANEL_SERVER_ID" ] || [ -z "$PANEL_API_KEY" ]; then
            echo "Error: Required environment variables are not set"
            exit 1
          fi
          # Remove trailing slashes from URL if present
          PANEL_URL="${PANEL_URL%/}"
          PANEL_SCHEME="https"
          if [[ "$PANEL_URL" == http://* ]]; then
            PANEL_SCHEME="http"
          fi
          PANEL_HOST_WITH_PORT="${PANEL_URL#http://}"
          PANEL_HOST_WITH_PORT="${PANEL_HOST_WITH_PORT#https://}"
          PANEL_HOST_WITH_PORT="${PANEL_HOST_WITH_PORT%%/*}"
          PANEL_HOST="${PANEL_HOST_WITH_PORT%%:*}"
          PANEL_PORT="${PANEL_HOST_WITH_PORT##*:}"
          if [ "$PANEL_PORT" = "$PANEL_HOST_WITH_PORT" ]; then
            if [ "$PANEL_SCHEME" = "http" ]; then
              PANEL_PORT="80"
            else
              PANEL_PORT="443"
            fi
          fi
          PANEL_REMOTE_ORIGIN="${PANEL_SCHEME}://${PANEL_HOST_WITH_PORT}"
          echo "panel_url=$PANEL_URL" >> $GITHUB_OUTPUT
          echo "panel_remote_origin=$PANEL_REMOTE_ORIGIN" >> $GITHUB_OUTPUT
          echo "panel_host=$PANEL_HOST" >> $GITHUB_OUTPUT
          echo "panel_host_with_port=$PANEL_HOST_WITH_PORT" >> $GITHUB_OUTPUT
          echo "panel_port=$PANEL_PORT" >> $GITHUB_OUTPUT

      - name: Start Cloudflare Access Proxy
        env:
          CF_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
          PANEL_HOST: ${{ steps.normalize-panel.outputs.panel_host }}
        run: |
          LOCAL_PORT="8080"
          echo "Starting Node.js Proxy on 127.0.0.1:${LOCAL_PORT} -> ${PANEL_HOST}..."

          # Create simple Node.js proxy script
          cat << 'EOF' > proxy.cjs
          const http = require('http');
          const https = require('https');

          const LOCAL_PORT = 8080;
          const PROXY_TARGET = process.env.PANEL_HOST;
          const CF_ID = (process.env.CF_ID || '').trim();
          const CF_SECRET = (process.env.CF_SECRET || '').trim();

          if (!CF_ID || !CF_SECRET || !PROXY_TARGET) {
            console.error('Error: Missing required environment variables');
            process.exit(1);
          }

          const server = http.createServer((clientReq, clientRes) => {
            const options = {
              hostname: PROXY_TARGET,
              port: 443,
              path: clientReq.url,
              method: clientReq.method,
              headers: {
                ...clientReq.headers,
                'CF-Access-Client-Id': CF_ID,
                'CF-Access-Client-Secret': CF_SECRET,
                'Host': PROXY_TARGET // IMPORTANT: Override Host header for SNI
              }
            };

            const proxyReq = https.request(options, (proxyRes) => {
              clientRes.writeHead(proxyRes.statusCode, proxyRes.headers);
              proxyRes.pipe(clientRes, { end: true });
            });

            proxyReq.on('error', (e) => {
              console.error(`Proxy Request Error: ${e.message}`);
              if (!clientRes.headersSent) {
                clientRes.writeHead(502);
                clientRes.end('Bad Gateway');
              }
            });

            clientReq.pipe(proxyReq, { end: true });
          });

          server.listen(LOCAL_PORT, '127.0.0.1', () => {
            console.log(`Node.js Proxy running on http://127.0.0.1:${LOCAL_PORT}`);
          });
          EOF

          # Run proxy in background
          nohup node proxy.cjs > proxy.log 2>&1 &

          echo "Waiting for proxy to start..."
          sleep 3

          echo "Testing panel connectivity via local proxy..."
          if ! curl -f -I --max-time 5 --retry 5 --retry-delay 2 --retry-all-errors "http://127.0.0.1:${LOCAL_PORT}"; then
            echo "Proxy failed. Recent logs:"
            cat proxy.log
            exit 1
          fi

      - name: Generate safe artifact name
        id: artifact-name
        run: |
          NAME="${{ inputs.version || github.event.release.tag_name }}"
          echo "safe_name=${NAME//\//-}" >> $GITHUB_OUTPUT

      - name: Download Build Artifact
        uses: actions/download-artifact@v6
        with:
          name: build-artifact-${{ steps.artifact-name.outputs.safe_name }}
          path: build-artifact

      - name: Create Backup
        id: create-backup
        uses: maxouxax/pterodactyl-create-backup-action@v1
        with:
          panel-url: http://127.0.0.1:8080
          api-key: ${{ secrets.PANEL_API_KEY }}
          server-id: ${{ secrets.PANEL_SERVER_ID }}

      - name: Create Archive for Upload
        run: |
          tar -czf app.tgz -C build-artifact .

      - name: Upload Artifact to Pterodactyl Panel
        id: upload
        uses: rexlManu/pterodactyl-upload-action@v2.5
        with:
          panel-host: http://127.0.0.1:8080
          api-key: ${{ secrets.PANEL_API_KEY }}
          restart: true
          server-id: ${{ secrets.PANEL_SERVER_ID }}
          source: app.tgz
          decompress-target: true
          target: app.tgz

      - name: Waiting for previous step to finish
        run: sleep 10

      - name: Cleanup
        run: |
          rm app.tgz
          rm -rf build-artifact
