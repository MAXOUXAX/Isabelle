# This workflow runs when a release is published, or the workflow is manually dispatched
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to deploy (git tag)"
        required: true
        type: string

name: Deploy to Pterodactyl

jobs:
  call-build-workflow:
    uses: ./.github/workflows/build.yml
    with:
      version: ${{ github.event.release.tag_name || inputs.version }}

  deploy:
    runs-on: ubuntu-latest
    needs: call-build-workflow
    environment: production

    env:
      PANEL_URL: ${{ secrets.PANEL_URL }}
      PANEL_SERVER_ID: ${{ secrets.PANEL_SERVER_ID }}
      PANEL_API_KEY: ${{ secrets.PANEL_API_KEY }}
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}

    steps:
      - name: Verify Required Secrets
        run: |
          if [ -z "$PANEL_URL" ] || [ -z "$PANEL_SERVER_ID" ] || [ -z "$PANEL_API_KEY" ] || [ -z "$CF_ACCESS_CLIENT_ID" ] || [ -z "$CF_ACCESS_CLIENT_SECRET" ]; then
            echo "Error: Required environment variables are not set"
            exit 1
          fi
          # Remove trailing slashes from URL if present
          PANEL_URL="${PANEL_URL%/}"
          echo "PANEL_URL=$PANEL_URL" >> $GITHUB_ENV
          PANEL_HOST="${PANEL_URL#http://}"
          PANEL_HOST="${PANEL_HOST#https://}"
          PANEL_HOST="${PANEL_HOST%%/*}"
          echo "PANEL_HOST=$PANEL_HOST" >> $GITHUB_ENV

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Map panel host to localhost
        run: |
          echo "127.0.0.1 $PANEL_HOST" | sudo tee -a /etc/hosts

      - name: Start Cloudflare Access proxy
        env:
          CF_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
        run: |
          sudo nohup cloudflared access tcp --hostname "$PANEL_HOST" --url 127.0.0.1:443 \
            --service-token-id "$CF_ID" \
            --service-token-secret "$CF_SECRET" > cloudflared.log 2>&1 &
          sleep 5
          echo "Testing panel connectivity via local tunnel..."
          curl -I "https://$PANEL_HOST" || echo "Warning: panel probe failed"

      - name: Generate safe artifact name
        id: artifact-name
        run: |
          NAME="${{ inputs.version || github.event.release.tag_name }}"
          echo "safe_name=${NAME//\//-}" >> $GITHUB_OUTPUT

      - name: Download Build Artifact
        uses: actions/download-artifact@v6
        with:
          name: build-artifact-${{ steps.artifact-name.outputs.safe_name }}
          path: build-artifact

      - name: Create Backup
        id: create-backup
        uses: maxouxax/pterodactyl-create-backup-action@v1
        with:
          panel-url: ${{ env.PANEL_URL }}
          api-key: ${{ env.PANEL_API_KEY }}
          server-id: ${{ env.PANEL_SERVER_ID }}

      - name: Create Archive for Upload
        run: |
          tar -czf app.tgz -C build-artifact .

      - name: Upload Artifact to Pterodactyl Panel
        id: upload
        uses: rexlManu/pterodactyl-upload-action@v2.5
        with:
          panel-host: ${{ env.PANEL_URL }}
          api-key: ${{ env.PANEL_API_KEY }}
          restart: true
          server-id: ${{ env.PANEL_SERVER_ID }}
          source: app.tgz
          decompress-target: true
          target: app.tgz

      - name: Waiting for previous step to finish
        run: sleep 10

      - name: Cleanup
        run: |
          rm app.tgz
          rm -rf build-artifact
